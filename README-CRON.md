# Настройка автоматической отправки постов

Для автоматической отправки запланированных постов можно использовать один из двух подходов:

1. Vercel Cron Jobs (встроенное решение, но с ограничениями на бесплатном тарифе)
2. Внешний сервис cron-job.org (позволяет запускать задачи каждую минуту бесплатно)

## Как это работает

1. API-эндпоинт `/api/send-scheduled-posts` проверяет базу данных на наличие постов со статусом "scheduled", время отправки которых уже наступило.
2. Для каждого найденного поста:
   - Отправляет сообщение в указанные Telegram-каналы
   - Обновляет статус поста на "sent" при успешной отправке или "failed" при ошибке

## Вариант 1: Настройка Vercel Cron Jobs

### 1. Конфигурация в vercel.json

```json
"crons": [
  {
    "path": "/api/send-scheduled-posts",
    "schedule": "0 * * * *"
  }
]
```

Расписание "0 * * * *" означает запуск каждый час (в начале часа).

### Ограничения Vercel для cron-задач

**Бесплатный тариф**:
- 2 cron-задачи на проект
- Минимальный интервал: каждый час (не каждую минуту)
- 100 выполнений в день

**Pro тариф**:
- Неограниченное количество cron-задач
- Минимальный интервал: каждую минуту
- 1000 выполнений в день

## Вариант 2: Использование cron-job.org (рекомендуется)

Если вам нужен запуск каждую минуту, вы можете использовать бесплатный сервис [cron-job.org](https://cron-job.org/en/), который позволяет настроить запуск до 60 раз в час (каждую минуту).

### Настройка cron-job.org:

1. Создайте аккаунт на [cron-job.org](https://cron-job.org/en/)
2. Нажмите "Create cronjob"
3. Укажите следующие настройки:
   - **Title**: Telexa Send Scheduled Posts
   - **URL**: https://telexa.vercel.app/api/send-scheduled-posts
   - **Schedule**: Every minute
   - **Advanced** → **Custom HTTP Headers**:
     - Имя: `Authorization`
     - Значение: `Bearer ваш_секретный_ключ` (тот же CRON_SECRET, что в Vercel)
4. Сохраните задачу

### Преимущества cron-job.org:
- Запуск каждую минуту (до 60 раз в час)
- Бесплатный сервис
- История выполнения и уведомления о сбоях
- Тестовые запуски для проверки конфигурации

## Безопасность

Для защиты API-эндпоинта от несанкционированного доступа используется переменная окружения `CRON_SECRET`. Vercel автоматически добавляет этот секрет в заголовок Authorization при выполнении cron-задачи.

1. Добавьте переменную окружения в проект на Vercel:
   - Перейдите в настройки проекта на Vercel
   - Добавьте переменную `CRON_SECRET` с уникальным значением
   
2. Для локального тестирования:
   - Добавьте `CRON_SECRET` в ваш локальный файл `.env`
   - При тестировании API используйте заголовок `Authorization: Bearer ваш_секретный_ключ`

## Ручной запуск

Если вам нужно запустить отправку постов вручную, используйте команду:

```bash
npm run send-posts
```

Или отправьте GET-запрос к эндпоинту с правильным заголовком авторизации:

```bash
curl -X GET -H "Authorization: Bearer ваш_секретный_ключ" https://telexa.vercel.app/api/send-scheduled-posts
```

## Мониторинг

- **Vercel**: Логи выполнения cron-задач можно просмотреть в разделе "Functions" на панели управления Vercel.
- **cron-job.org**: История выполнения доступна в интерфейсе cron-job.org с подробной информацией о каждом запуске. 